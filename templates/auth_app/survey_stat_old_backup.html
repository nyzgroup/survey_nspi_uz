{% extends 'auth_app/base.html' %}

{% block page_title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="survey-stats-page">
  <div class="container-fluid px-3 px-md-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="h3 mb-0 text-dark">{{ page_title }}</h2>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="refreshStats()">
          <i class="fas fa-sync-alt me-2"></i>Yangilash
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="exportStats()">
          <i class="fas fa-download me-2"></i>Eksport
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading-indicator" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Yuklanmoqda...</span>
      </div>
      <p class="mt-3 text-muted">Statistika ma'lumotlari yuklanmoqda...</p>
    </div>

    <!-- Statistics Container -->
    <div id="survey-stat-root" class="d-none">
      <!-- Stats Overview Cards -->
      <div class="row g-4 mb-4">
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card stat-card text-center">
            <div class="card-body">
              <div class="stat-icon bg-primary text-white rounded-circle mx-auto mb-3">
                <i class="fas fa-users fa-2x"></i>
              </div>
              <h3 class="stat-number text-primary" id="total-participants">0</h3>
              <p class="stat-label text-muted mb-0">Jami ishtirokchilar</p>
            </div>
          </div>
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card stat-card text-center">
            <div class="card-body">
              <div class="stat-icon bg-success text-white rounded-circle mx-auto mb-3">
                <i class="fas fa-check-circle fa-2x"></i>
              </div>
              <h3 class="stat-number text-success" id="completed-surveys">0</h3>
              <p class="stat-label text-muted mb-0">To'ldirilgan so'rovnomalar</p>
            </div>
          </div>  
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card stat-card text-center">
            <div class="card-body">
              <div class="stat-icon bg-warning text-white rounded-circle mx-auto mb-3">
                <i class="fas fa-clock fa-2x"></i>
              </div>
              <h3 class="stat-number text-warning" id="pending-surveys">0</h3>
              <p class="stat-label text-muted mb-0">Kutilayotgan javoblar</p>
            </div>
          </div>
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card stat-card text-center">
            <div class="card-body">
              <div class="stat-icon bg-info text-white rounded-circle mx-auto mb-3">
                <i class="fas fa-percentage fa-2x"></i>
              </div>
              <h3 class="stat-number text-info" id="completion-rate">0%</h3>
              <p class="stat-label text-muted mb-0">Bajarilish foizi</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="row g-4 mb-4">
        <!-- Response Distribution Chart -->
        <div class="col-12 col-lg-6">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-chart-pie me-2"></i>Javoblar taqsimoti
              </h5>
            </div>
            <div class="card-body">
              <canvas id="responseChart" width="400" height="300"></canvas>
            </div>
          </div>
        </div>
        
        <!-- Timeline Chart -->
        <div class="col-12 col-lg-6">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-chart-line me-2"></i>Vaqt bo'yicha javoblar
              </h5>
            </div>
            <div class="card-body">
              <canvas id="timelineChart" width="400" height="300"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Detailed Statistics Table -->
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-table me-2"></i>Batafsil statistika
          </h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover" id="detailed-stats-table">
              <thead class="table-light">
                <tr>
                  <th>Savol</th>
                  <th>Javoblar soni</th>
                  <th>Foiz</th>
                  <th>O'rtacha ball</th>
                </tr>
              </thead>
              <tbody>
                <!-- Data will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Error State -->
    <div id="error-state" class="d-none text-center py-5">
      <i class="fas fa-exclamation-triangle text-warning mb-3" style="font-size: 3rem;"></i>
      <h5 class="text-muted mb-3">Ma'lumotlarni yuklashda xatolik</h5>
      <button class="btn btn-primary" onclick="loadStats()">
        <i class="fas fa-redo me-2"></i>Qayta urinish
      </button>
    </div>
  </div>
</div>

<!-- Custom Styles -->
<style>
.survey-stats-page .stat-card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  border: 1px solid rgba(0,0,0,0.1);
}

.survey-stats-page .stat-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}

.survey-stats-page .stat-icon {
  width: 70px;
  height: 70px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.survey-stats-page .stat-number {
  font-size: 2.5rem;
  font-weight: bold;
  margin-bottom: 0;
}

.survey-stats-page .stat-label {
  font-size: 0.9rem;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .survey-stats-page .d-flex.justify-content-between {
    flex-direction: column;
    align-items: flex-start !important;
    gap: 1rem;
  }
  
  .survey-stats-page .stat-icon {
    width: 60px;
    height: 60px;
  }
  
  .survey-stats-page .stat-number {
    font-size: 2rem;
  }
  
  .survey-stats-page .btn-sm {
    font-size: 0.8rem;
    padding: 0.4rem 0.8rem;
  }
}

@media (max-width: 576px) {
  .survey-stats-page .stat-icon {
    width: 50px;
    height: 50px;
  }
  
  .survey-stats-page .stat-number {
    font-size: 1.8rem;
  }
  
  .survey-stats-page .card-body {
    padding: 1rem;
  }
  
  .survey-stats-page .d-flex.gap-2 {
    flex-direction: column;
    width: 100%;
  }
  
  .survey-stats-page .btn {
    width: 100%;
  }
}
</style>

<!-- JavaScript for Statistics -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const surveyId = "{{ survey.id }}";
  const loadingIndicator = document.getElementById('loading-indicator');
  const statsContainer = document.getElementById('survey-stat-root');
  const errorState = document.getElementById('error-state');

  // Load statistics on page load
  loadStats();

  function loadStats() {
    showLoading();
    
    // API call to fetch statistics
    fetch(`/api/surveys/${surveyId}/stats/`)
      .then(response => response.json())
      .then(data => {
        hideLoading();
        updateStatistics(data);
        renderCharts(data);
        showStats();
      })
      .catch(error => {
        console.error('Error loading statistics:', error);
        hideLoading();
        showError();
      });
  }

  function showLoading() {
    loadingIndicator.classList.remove('d-none');
    statsContainer.classList.add('d-none');
    errorState.classList.add('d-none');
  }

  function hideLoading() {
    loadingIndicator.classList.add('d-none');
  }

  function showStats() {
    statsContainer.classList.remove('d-none');
    errorState.classList.add('d-none');
  }

  function showError() {
    errorState.classList.remove('d-none');
    statsContainer.classList.add('d-none');
  }

  function updateStatistics(data) {
    // Update overview cards
    document.getElementById('total-participants').textContent = data.total_participants || 0;
    document.getElementById('completed-surveys').textContent = data.completed_surveys || 0;
    document.getElementById('pending-surveys').textContent = data.pending_surveys || 0;
    document.getElementById('completion-rate').textContent = (data.completion_rate || 0) + '%';

    // Update detailed table
    const tableBody = document.querySelector('#detailed-stats-table tbody');
    tableBody.innerHTML = '';
    
    if (data.question_stats) {
      data.question_stats.forEach(stat => {
        const row = `
          <tr>
            <td>${stat.question}</td>
            <td>${stat.responses}</td>
            <td>${stat.percentage}%</td>
            <td>${stat.average_score || 'N/A'}</td>
          </tr>
        `;
        tableBody.innerHTML += row;
      });
    }
  }

  function renderCharts(data) {
    // Response Distribution Pie Chart
    const responseChart = document.getElementById('responseChart');
    if (responseChart && data.response_distribution) {
      // Chart.js implementation would go here
      console.log('Rendering response chart with data:', data.response_distribution);
    }

    // Timeline Chart
    const timelineChart = document.getElementById('timelineChart');
    if (timelineChart && data.timeline_data) {
      // Chart.js implementation would go here
      console.log('Rendering timeline chart with data:', data.timeline_data);
    }
  }

  // Global functions for buttons
  window.refreshStats = function() {
    loadStats();
  };

  window.exportStats = function() {
    // Export functionality
    window.open(`/api/surveys/${surveyId}/export/`, '_blank');
  };
});
</script>
{% endblock %}
