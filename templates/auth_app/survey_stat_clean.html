{% extends 'auth_app/base.html' %}

{% block page_title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="survey-stats-page">
  <div class="container-fluid px-3 px-md-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="h3 mb-0 text-dark">{{ page_title }}</h2>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="refreshStats()">
          <i class="fas fa-sync-alt me-2"></i>Yangilash
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="exportStats()">
          <i class="fas fa-download me-2"></i>Eksport
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading-indicator" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Yuklanmoqda...</span>
      </div>
      <p class="mt-3 text-muted">Statistika ma'lumotlari yuklanmoqda...</p>
    </div>

    <!-- Statistics Container -->
    <div id="survey-stat-root" class="d-none">
      <!-- Survey Basic Info -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card border-primary">
            <div class="card-header bg-primary text-white">
              <h5 class="card-title mb-0">
                <i class="fas fa-info-circle me-2"></i>So'rovnoma haqida
              </h5>
            </div>
            <div class="card-body" id="survey-info">
              <!-- Survey info will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>

      <!-- Stats Overview Cards -->
      <div class="row g-4 mb-4">
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card stat-card text-center">
            <div class="card-body">
              <div class="stat-icon bg-primary text-white rounded-circle mx-auto mb-3">
                <i class="fas fa-users fa-2x"></i>
              </div>
              <h3 class="stat-number text-primary" id="total-participants">0</h3>
              <p class="stat-label text-muted mb-0">Jami ishtirokchilar</p>
            </div>
          </div>
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card stat-card text-center">
            <div class="card-body">
              <div class="stat-icon bg-success text-white rounded-circle mx-auto mb-3">
                <i class="fas fa-check-circle fa-2x"></i>
              </div>
              <h3 class="stat-number text-success" id="total-questions">0</h3>
              <p class="stat-label text-muted mb-0">Jami savollar</p>
            </div>
          </div>  
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card stat-card text-center">
            <div class="card-body">
              <div class="stat-icon bg-warning text-white rounded-circle mx-auto mb-3">
                <i class="fas fa-clock fa-2x"></i>
              </div>
              <h3 class="stat-number text-warning" id="avg-responses">0</h3>
              <p class="stat-label text-muted mb-0">O'rtacha javoblar</p>
            </div>
          </div>
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card stat-card text-center">
            <div class="card-body">
              <div class="stat-icon bg-info text-white rounded-circle mx-auto mb-3">
                <i class="fas fa-percentage fa-2x"></i>
              </div>
              <h3 class="stat-number text-info" id="completion-rate">0%</h3>
              <p class="stat-label text-muted mb-0">Bajarilish foizi</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Demographics Section -->
      <div class="row mb-4" id="demographics-section">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-users me-2"></i>Demografik taqsimot
              </h5>
            </div>
            <div class="card-body">
              <div id="demographics-container">
                <!-- Demographics will be populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Questions Statistics -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-question-circle me-2"></i>Savollar bo'yicha statistika
              </h5>
            </div>
            <div class="card-body">
              <div id="questions-stats-container">
                <!-- Questions stats will be populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Responses -->
      <div class="row mb-4" id="responses-section">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-clock me-2"></i>So'nggi javoblar (birinchi 20 ta)
              </h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-sm table-hover" id="responses-table">
                  <thead class="table-light">
                    <tr>
                      <th>Student ID</th>
                      <th>F.I.Sh</th>
                      <th>Fakultet</th>
                      <th>Kurs</th>
                      <th>Javob berilgan vaqt</th>
                      <th>Javoblar soni</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Responses data will be populated by JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Error State -->
    <div id="error-state" class="d-none text-center py-5">
      <i class="fas fa-exclamation-triangle text-warning mb-3" style="font-size: 3rem;"></i>
      <h5 class="text-muted mb-3">Ma'lumotlarni yuklashda xatolik</h5>
      <button class="btn btn-primary" onclick="loadStats()">
        <i class="fas fa-redo me-2"></i>Qayta urinish
      </button>
    </div>
  </div>
</div>

<!-- Custom Styles -->
<style>
.survey-stats-page .stat-card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  border: 1px solid rgba(0,0,0,0.1);
}

.survey-stats-page .stat-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}

.survey-stats-page .stat-icon {
  width: 70px;
  height: 70px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.survey-stats-page .stat-number {
  font-size: 2.5rem;
  font-weight: bold;
  margin-bottom: 0;
}

.survey-stats-page .stat-label {
  font-size: 0.9rem;
}

.demographic-item {
  padding: 0.5rem;
  margin: 0.25rem 0;
  background: #f8f9fa;
  border-radius: 0.375rem;
  border-left: 4px solid #007bff;
}

.question-stat-item {
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
  padding: 1rem;
  margin-bottom: 1rem;
  background: #fff;
}

.choice-bar {
  background: #e9ecef;
  border-radius: 0.25rem;
  height: 1.5rem;
  position: relative;
  margin: 0.25rem 0;
}

.choice-fill {
  background: linear-gradient(90deg, #007bff, #0056b3);
  height: 100%;
  border-radius: 0.25rem;
  transition: width 0.5s ease;
}

.choice-text {
  position: absolute;
  left: 0.5rem;
  top: 50%;
  transform: translateY(-50%);
  font-size: 0.875rem;
  font-weight: 500;
  color: #495057;
  z-index: 1;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .survey-stats-page .d-flex.justify-content-between {
    flex-direction: column;
    align-items: flex-start !important;
    gap: 1rem;
  }
  
  .survey-stats-page .stat-icon {
    width: 60px;
    height: 60px;
  }
  
  .survey-stats-page .stat-number {
    font-size: 2rem;
  }
  
  .survey-stats-page .btn-sm {
    font-size: 0.8rem;
    padding: 0.4rem 0.8rem;
  }
}

@media (max-width: 576px) {
  .survey-stats-page .stat-icon {
    width: 50px;
    height: 50px;
  }
  
  .survey-stats-page .stat-number {
    font-size: 1.8rem;
  }
  
  .survey-stats-page .card-body {
    padding: 1rem;
  }
  
  .survey-stats-page .d-flex.gap-2 {
    flex-direction: column;
    width: 100%;
  }
  
  .survey-stats-page .btn {
    width: 100%;
  }
}
</style>

<!-- JavaScript for Statistics -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const surveyId = "{{ survey.id }}";
  const loadingIndicator = document.getElementById('loading-indicator');
  const statsContainer = document.getElementById('survey-stat-root');
  const errorState = document.getElementById('error-state');

  // Load statistics on page load
  loadStats();

  function loadStats() {
    showLoading();
    
    // API call to fetch statistics
    fetch(`/api/surveys/${surveyId}/statistics/`)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('Received data:', data);
        hideLoading();
        updateStatistics(data);
        showStats();
      })
      .catch(error => {
        console.error('Error loading statistics:', error);
        hideLoading();
        showError();
      });
  }

  function showLoading() {
    loadingIndicator.classList.remove('d-none');
    statsContainer.classList.add('d-none');
    errorState.classList.add('d-none');
  }

  function hideLoading() {
    loadingIndicator.classList.add('d-none');
  }

  function showStats() {
    statsContainer.classList.remove('d-none');
    errorState.classList.add('d-none');
  }

  function showError() {
    errorState.classList.remove('d-none');
    statsContainer.classList.add('d-none');
  }

  function updateStatistics(data) {
    // Update survey info
    updateSurveyInfo(data.survey_info || {});
    
    // Update overview cards
    document.getElementById('total-participants').textContent = data.total_participants || 0;
    document.getElementById('total-questions').textContent = data.survey_info?.questions_count || 0;
    document.getElementById('avg-responses').textContent = Math.round(data.summary?.average_responses_per_question || 0);
    document.getElementById('completion-rate').textContent = (data.summary?.completion_rate || 0) + '%';

    // Update demographics
    updateDemographics(data.demographics || {});
    
    // Update questions statistics
    updateQuestionsStats(data.questions_statistics || []);
    
    // Update recent responses
    updateRecentResponses(data.responses_details || []);
  }

  function updateSurveyInfo(surveyInfo) {
    const container = document.getElementById('survey-info');
    const createdAt = surveyInfo.created_at ? new Date(surveyInfo.created_at).toLocaleString('uz-UZ') : 'Noma\'lum';
    const isActive = surveyInfo.is_active ? 'Faol' : 'Nofaol';
    const isAnonymous = surveyInfo.is_anonymous ? 'Ha' : 'Yo\'q';
    
    container.innerHTML = `
      <div class="row">
        <div class="col-md-6">
          <p><strong>Sarlavha:</strong> ${surveyInfo.title || 'Noma\'lum'}</p>
          <p><strong>Yaratilgan vaqt:</strong> ${createdAt}</p>
          <p><strong>Savollar soni:</strong> ${surveyInfo.questions_count || 0}</p>
        </div>
        <div class="col-md-6">
          <p><strong>Holati:</strong> <span class="badge ${surveyInfo.is_active ? 'bg-success' : 'bg-secondary'}">${isActive}</span></p>
          <p><strong>Anonim:</strong> <span class="badge ${surveyInfo.is_anonymous ? 'bg-warning' : 'bg-info'}">${isAnonymous}</span></p>
          <p><strong>Jami javoblar:</strong> ${surveyInfo.total_responses || 0}</p>
        </div>
      </div>
    `;
  }

  function updateDemographics(demographics) {
    const container = document.getElementById('demographics-container');
    let html = '<div class="row">';
    
    Object.entries(demographics).forEach(([key, stats]) => {
      if (Object.keys(stats).length > 0) {
        const title = getDemographicTitle(key);
        html += `<div class="col-md-6 col-lg-4 mb-3">
          <h6 class="fw-bold">${title}</h6>`;
        
        Object.entries(stats).forEach(([label, count]) => {
          html += `<div class="demographic-item d-flex justify-content-between">
            <span>${label}</span>
            <strong>${count}</strong>
          </div>`;
        });
        
        html += '</div>';
      }
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    // Hide demographics section if no data
    const section = document.getElementById('demographics-section');
    if (Object.keys(demographics).length === 0) {
      section.style.display = 'none';
    }
  }

  function getDemographicTitle(key) {
    const titles = {
      'by_faculty': 'Fakultet bo\'yicha',
      'by_level': 'Kurs bo\'yicha', 
      'by_gender': 'Jins bo\'yicha',
      'by_education_form': 'Ta\'lim shakli bo\'yicha',
      'by_payment_form': 'To\'lov shakli bo\'yicha',
      'by_social_category': 'Ijtimoiy holat bo\'yicha',
      'by_accommodation': 'Turar joy bo\'yicha'
    };
    return titles[key] || key;
  }

  function updateQuestionsStats(questionsStats) {
    const container = document.getElementById('questions-stats-container');
    let html = '';
    
    questionsStats.forEach((question, index) => {
      html += `
        <div class="question-stat-item">
          <h6 class="fw-bold mb-3">${index + 1}. ${question.text}</h6>
          <div class="row mb-2">
            <div class="col-6"><small class="text-muted">Turi: <strong>${getQuestionType(question.question_type)}</strong></small></div>
            <div class="col-6"><small class="text-muted">Javoblar: <strong>${question.total_answers}</strong></small></div>
          </div>
      `;
      
      if (question.question_type === 'text') {
        html += '<div class="mt-3"><h6>Matnli javoblar (birinchi 10 ta):</h6>';
        question.text_answers.slice(0, 10).forEach(answer => {
          html += `<div class="alert alert-light py-2 px-3 mb-1 small">${answer}</div>`;
        });
        html += '</div>';
      } else if (question.choices_stats && question.choices_stats.length > 0) {
        html += '<div class="mt-3">';
        question.choices_stats.forEach(choice => {
          const percentage = choice.percentage || 0;
          html += `
            <div class="mb-2">
              <div class="d-flex justify-content-between mb-1">
                <span class="small">${choice.text}</span>
                <span class="small fw-bold">${choice.count} (${percentage}%)</span>
              </div>
              <div class="choice-bar">
                <div class="choice-fill" style="width: ${percentage}%"></div>
              </div>
            </div>
          `;
        });
        html += '</div>';
      }
      
      html += '</div>';
    });
    
    container.innerHTML = html;
  }

  function getQuestionType(type) {
    const types = {
      'single_choice': 'Bitta tanlov',
      'multiple_choice': 'Ko\'p tanlov',
      'text': 'Matn'
    };
    return types[type] || type;
  }

  function updateRecentResponses(responses) {
    const tableBody = document.querySelector('#responses-table tbody');
    tableBody.innerHTML = '';
    
    if (responses.length === 0) {
      document.getElementById('responses-section').style.display = 'none';
      return;
    }
    
    responses.slice(0, 20).forEach(response => {
      const student = response.student_info || {};
      const submittedAt = response.submitted_at ? 
        new Date(response.submitted_at).toLocaleString('uz-UZ') : 'Noma\'lum';
      
      const row = `
        <tr>
          <td>${student.student_id_number || 'N/A'}</td>
          <td>${student.full_name || 'N/A'}</td>
          <td>${student.faculty || 'N/A'}</td>
          <td>${student.level || 'N/A'}</td>
          <td>${submittedAt}</td>
          <td><span class="badge bg-primary">${response.answers_count || 0}</span></td>
        </tr>
      `;
      tableBody.innerHTML += row;
    });
  }

  // Global functions for buttons
  window.refreshStats = function() {
    loadStats();
  };

  window.exportStats = function() {
    // Create CSV content
    const csvContent = "data:text/csv;charset=utf-8,Statistika eksporti\n";
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `survey_${surveyId}_statistics.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };
});
</script>
{% endblock %}
