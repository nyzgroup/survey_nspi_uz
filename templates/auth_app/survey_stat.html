{% extends 'auth_app/base.html' %}
{% load static %}

{% block page_title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- AOS Animation Library -->
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

<!-- Survey Statistics Custom Styles -->
<style>
/* Modern Design Variables */
:root {
  --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
  --info-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
  --danger-gradient: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
  --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
  --secondary-gradient: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%);
  --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.1);
  --shadow-medium: 0 4px 20px rgba(0, 0, 0, 0.15);
  --shadow-heavy: 0 8px 30px rgba(0, 0, 0, 0.2);
  --border-radius: 12px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Page Layout */
.survey-stats-page {
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  min-height: 100vh;
  padding: 2rem 0;
}

/* Header Styling */
.stats-header {
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
  border-radius: var(--border-radius);
  padding: 2rem;
  box-shadow: var(--shadow-light);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.stats-header h1 {
  background: var(--primary-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-size: 2.5rem;
  font-weight: 700;
}

/* Modern Buttons */
.btn-modern {
  border-radius: 25px;
  padding: 0.75rem 1.5rem;
  font-weight: 600;
  letter-spacing: 0.5px;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.btn-modern::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.5s;
}

.btn-modern:hover::before {
  left: 100%;
}

.btn-modern:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-medium);
}

/* Modern Cards */
.modern-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-radius: var(--border-radius);
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: var(--shadow-light);
  transition: var(--transition);
  overflow: hidden;
}

.modern-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-heavy);
}

.card-header-modern {
  padding: 1.25rem;
  border: none;
  position: relative;
}

.bg-gradient-primary { background: var(--primary-gradient) !important; }
.bg-gradient-success { background: var(--success-gradient) !important; }
.bg-gradient-warning { background: var(--warning-gradient) !important; }
.bg-gradient-info { background: var(--info-gradient) !important; }
.bg-gradient-danger { background: var(--danger-gradient) !important; }
.bg-gradient-dark { background: var(--dark-gradient) !important; }
.bg-gradient-secondary { background: var(--secondary-gradient) !important; }

/* Modern Stat Cards */
.modern-stat-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-radius: var(--border-radius);
  padding: 2rem;
  text-align: center;
  transition: var(--transition);
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: var(--shadow-light);
  position: relative;
  overflow: hidden;
}

.modern-stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--primary-gradient);
}

.modern-stat-card:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: var(--shadow-heavy);
}

.stat-icon-modern {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 1.5rem;
  font-size: 2rem;
  color: white;
  position: relative;
  overflow: hidden;
}

.stat-icon-modern::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 50%;
  transform: scale(0);
  transition: transform 0.3s ease;
}

.modern-stat-card:hover .stat-icon-modern::before {
  transform: scale(1);
}

.stat-number {
  font-size: 3rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
  background: var(--primary-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.stat-label {
  color: #6c757d;
  font-weight: 500;
  font-size: 1rem;
  margin: 0;
}

/* Chart Cards */
.chart-card {
  height: 100%;
}

.chart-card .card-body {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 400px;
}

/* Modern Table */
.table-modern {
  border-collapse: separate;
  border-spacing: 0;
}

.table-modern thead th {
  background: var(--primary-gradient);
  color: white;
  font-weight: 600;
  border: none;
  padding: 1rem;
  position: relative;
}

.table-modern thead th:first-child {
  border-top-left-radius: var(--border-radius);
}

.table-modern thead th:last-child {
  border-top-right-radius: var(--border-radius);
}

.table-modern tbody tr {
  transition: var(--transition);
}

.table-modern tbody tr:hover {
  background: rgba(102, 126, 234, 0.1);
  transform: scale(1.01);
}

.table-modern tbody td {
  padding: 1rem;
  border: none;
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

/* Loading Animation */
.modern-loader {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0.5rem;
}

.modern-loader .spinner-grow {
  width: 3rem;
  height: 3rem;
}

/* Error State */
.error-icon i {
  font-size: 4rem;
  color: #ffc107;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

/* Survey Info Card */
.survey-info-card .card-body {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
}

/* Question Stats */
.question-stat-item {
  background: rgba(255, 255, 255, 0.7);
  border-radius: var(--border-radius);
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  border: 1px solid rgba(0, 0, 0, 0.05);
  transition: var(--transition);
}

.question-stat-item:hover {
  background: rgba(255, 255, 255, 0.9);
  transform: translateX(10px);
  box-shadow: var(--shadow-light);
}

.choice-bar {
  height: 8px;
  background: rgba(0, 0, 0, 0.1);
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}

.choice-fill {
  height: 100%;
  background: var(--primary-gradient);
  border-radius: 4px;
  transition: width 1s ease;
  position: relative;
}

.choice-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* Demographics Section */
.demographic-section {
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(5px);
  transition: var(--transition);
}

.demographic-section:hover {
  background: rgba(255, 255, 255, 0.95);
  transform: translateY(-2px);
}

.demographic-item {
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  transition: var(--transition);
}

.demographic-item:hover {
  background: rgba(102, 126, 234, 0.05);
  padding-left: 1rem;
}

/* No Data State */
.no-data-chart {
  transition: var(--transition);
}

.no-data-chart:hover {
  transform: scale(1.02);
}

/* Responsive Design */
@media (max-width: 768px) {
  .stats-header h1 {
    font-size: 2rem;
  }
  
  .stats-header {
    padding: 1.5rem;
  }
  
  .modern-stat-card {
    padding: 1.5rem;
  }
  
  .stat-icon-modern {
    width: 60px;
    height: 60px;
    font-size: 1.5rem;
  }
  
  .stat-number {
    font-size: 2.5rem;
  }
  
  .btn-modern {
    width: 100%;
    margin-bottom: 0.5rem;
  }
  
  .chart-card .card-body {
    min-height: 300px;
  }
}

@media (max-width: 576px) {
  .survey-stats-page {
    padding: 1rem 0;
  }
  
  .stats-header h1 {
    font-size: 1.8rem;
  }
  
  .modern-stat-card {
    padding: 1rem;
  }
  
  .stat-number {
    font-size: 2rem;
  }
  
  .chart-card .card-body {
    min-height: 250px;
  }
}

/* Animation classes */
.fade-in-up {
  animation: fadeInUp 0.6s ease forwards;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Chart hover effects */
.chart-card:hover {
  transform: translateY(-3px);
}

/* Custom scrollbar */
.table-responsive::-webkit-scrollbar {
  height: 8px;
}

.table-responsive::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb {
  background: var(--primary-gradient);
  border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
  background: var(--dark-gradient);
}
</style>
{% endblock %}

{% block content %}
<div class="survey-stats-page">
  <div class="container-fluid px-3 px-md-4">
    <!-- Modern Header Section -->
    <div class="stats-header mb-5" data-aos="fade-down">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h2 mb-2 text-dark fw-bold">ðŸ“Š {{ page_title }}</h1>
          <p class="text-muted mb-0">So'rovnoma natijalarining batafsil tahlili</p>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-modern" onclick="refreshStats()">
            <i class="fas fa-sync-alt me-2"></i>Yangilash
          </button>
          <button class="btn btn-outline-success btn-modern" onclick="exportStats()">
            <i class="fas fa-download me-2"></i>Eksport
          </button>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading-indicator" class="text-center py-5">
      <div class="modern-loader">
        <div class="spinner-grow text-primary" role="status">
          <span class="visually-hidden">Yuklanmoqda...</span>
        </div>
      </div>
      <p class="mt-3 text-muted fw-medium">Statistika ma'lumotlari yuklanmoqda...</p>
    </div>

    <!-- Error State -->
    <div id="error-state" class="text-center py-5 d-none" data-aos="fade-in">
      <div class="error-icon mb-4">
        <i class="fas fa-exclamation-triangle text-warning"></i>
      </div>
      <h4 class="text-dark mb-3">Xatolik yuz berdi</h4>
      <p class="text-muted mb-4">Statistika ma'lumotlarini yuklashda muammo bo'ldi.</p>
      <button class="btn btn-primary btn-modern" onclick="refreshStats()">
        <i class="fas fa-sync-alt me-2"></i>Qayta urinish
      </button>
    </div>

    <!-- Statistics Container -->
    <div id="survey-stat-root" class="d-none">
      <!-- Survey Basic Info Card -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="modern-card survey-info-card" data-aos="fade-up">
            <div class="card-header-modern bg-gradient-primary">
              <h5 class="mb-0 text-white">
                <i class="fas fa-info-circle me-2"></i>So'rovnoma haqida ma'lumot
              </h5>
            </div>
            <div class="card-body p-4" id="survey-info">
              <!-- Survey info will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>

      <!-- Stats Overview Cards -->
      <div class="row g-4 mb-5">
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="modern-stat-card" data-aos="zoom-in" data-aos-delay="100">
            <div class="stat-icon-modern bg-gradient-primary">
              <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
              <h3 class="stat-number text-primary" id="total-participants">0</h3>
              <p class="stat-label">Jami ishtirokchilar</p>
            </div>
          </div>
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="modern-stat-card" data-aos="zoom-in" data-aos-delay="200">
            <div class="stat-icon-modern bg-gradient-success">
              <i class="fas fa-question-circle"></i>
            </div>
            <div class="stat-content">
              <h3 class="stat-number text-success" id="total-questions">0</h3>
              <p class="stat-label">Jami savollar</p>
            </div>
          </div>  
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="modern-stat-card" data-aos="zoom-in" data-aos-delay="300">
            <div class="stat-icon-modern bg-gradient-warning">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
              <h3 class="stat-number text-warning" id="avg-responses">0</h3>
              <p class="stat-label">O'rtacha javoblar</p>
            </div>
          </div>
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="modern-stat-card" data-aos="zoom-in" data-aos-delay="400">
            <div class="stat-icon-modern bg-gradient-info">
              <i class="fas fa-percentage"></i>
            </div>
            <div class="stat-content">
              <h3 class="stat-number text-info" id="completion-rate">0%</h3>
              <p class="stat-label">Bajarilish foizi</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="row mb-5">
        <!-- Demographics Pie Charts -->
        <div class="col-lg-6 mb-4">
          <div class="modern-card chart-card" data-aos="fade-right">
            <div class="card-header-modern bg-gradient-info">
              <h5 class="mb-0 text-white">
                <i class="fas fa-chart-pie me-2"></i>Fakultet bo'yicha taqsimot
              </h5>
            </div>
            <div class="card-body">
              <canvas id="facultyChart" width="400" height="400"></canvas>
            </div>
          </div>
        </div>

        <div class="col-lg-6 mb-4">
          <div class="modern-card chart-card" data-aos="fade-left">
            <div class="card-header-modern bg-gradient-success">
              <h5 class="mb-0 text-white">
                <i class="fas fa-chart-pie me-2"></i>Kurs bo'yicha taqsimot
              </h5>
            </div>
            <div class="card-body">
              <canvas id="levelChart" width="400" height="400"></canvas>
            </div>
          </div>
        </div>

        <!-- Gender & Education Form Charts -->
        <div class="col-lg-6 mb-4">
          <div class="modern-card chart-card" data-aos="fade-right" data-aos-delay="100">
            <div class="card-header-modern bg-gradient-warning">
              <h5 class="mb-0 text-white">
                <i class="fas fa-chart-donut me-2"></i>Jins bo'yicha taqsimot
              </h5>
            </div>
            <div class="card-body">
              <canvas id="genderChart" width="400" height="400"></canvas>
            </div>
          </div>
        </div>

        <div class="col-lg-6 mb-4">
          <div class="modern-card chart-card" data-aos="fade-left" data-aos-delay="100">
            <div class="card-header-modern bg-gradient-danger">
              <h5 class="mb-0 text-white">
                <i class="fas fa-chart-bar me-2"></i>Ta'lim shakli bo'yicha
              </h5>
            </div>
            <div class="card-body">
              <canvas id="educationChart" width="400" height="400"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Classic Demographics Table (Eski usul) -->
      <div class="row mb-5" id="demographics-section">
        <div class="col-12">
          <div class="modern-card" data-aos="fade-up">
            <div class="card-header-modern bg-gradient-secondary">
              <h5 class="mb-0 text-white">
                <i class="fas fa-table me-2"></i>Demografik ma'lumotlar (Jadval ko'rinishi)
              </h5>
            </div>
            <div class="card-body">
              <div id="demographics-container">
                <!-- Demographics will be populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Questions Analysis Section -->
      <div class="row mb-5">
        <div class="col-12">
          <div class="modern-card" data-aos="fade-up">
            <div class="card-header-modern bg-gradient-primary">
              <h5 class="mb-0 text-white">
                <i class="fas fa-chart-line me-2"></i>Savollar bo'yicha tahlil
              </h5>
            </div>
            <div class="card-body">
              <canvas id="questionsChart" height="300"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Detailed Questions Statistics -->
      <div class="row mb-5">
        <div class="col-12">
          <div class="modern-card" data-aos="fade-up" data-aos-delay="100">
            <div class="card-header-modern bg-gradient-secondary">
              <h5 class="mb-0 text-white">
                <i class="fas fa-list-alt me-2"></i>Batafsil savollar statistikasi
              </h5>
            </div>
            <div class="card-body">
              <div id="questions-stats-container">
                <!-- Questions stats will be populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Responses with Modern Design -->
      <div class="row mb-4" id="responses-section">
        <div class="col-12">
          <div class="modern-card" data-aos="fade-up" data-aos-delay="200">
            <div class="card-header-modern bg-gradient-dark">
              <h5 class="mb-0 text-white">
                <i class="fas fa-clock me-2"></i>So'nggi javoblar (birinchi 20 ta)
              </h5>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-modern mb-0" id="responses-table">
                  <thead>
                    <tr>
                      <th>Student ID</th>
                      <th>F.I.Sh</th>
                      <th>Fakultet</th>
                      <th>Kurs</th>
                      <th>Javob berilgan vaqt</th>
                      <th>Javoblar soni</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Responses data will be populated by JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Advanced JavaScript with Chart.js Integration -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize AOS Animation
  AOS.init({
    duration: 800,
    once: true,
    offset: 100
  });

  const surveyId = "{{ survey.id }}";
  const loadingIndicator = document.getElementById('loading-indicator');
  const statsContainer = document.getElementById('survey-stat-root');
  const errorState = document.getElementById('error-state');

  // Chart instances storage
  let charts = {};

  // Chart.js default config
  Chart.defaults.responsive = true;
  Chart.defaults.maintainAspectRatio = false;
  Chart.defaults.plugins.legend.position = 'bottom';
  Chart.defaults.plugins.legend.labels.usePointStyle = true;
  Chart.defaults.plugins.legend.labels.padding = 20;

  // Load statistics on page load
  loadStats();

  function loadStats() {
    showLoading();
    
    // API call to fetch statistics
    fetch(`/api/surveys/${surveyId}/statistics/`)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('Received data:', data);
        hideLoading();
        updateStatistics(data);
        createCharts(data);
        showStats();
        
        // Re-initialize AOS after content load
        setTimeout(() => {
          AOS.refresh();
        }, 100);
      })
      .catch(error => {
        console.error('Error loading statistics:', error);
        hideLoading();
        showError();
      });
  }

  function showLoading() {
    loadingIndicator.classList.remove('d-none');
    statsContainer.classList.add('d-none');
    errorState.classList.add('d-none');
  }

  function hideLoading() {
    loadingIndicator.classList.add('d-none');
  }

  function showStats() {
    statsContainer.classList.remove('d-none');
    errorState.classList.add('d-none');
  }

  function showError() {
    errorState.classList.remove('d-none');
    statsContainer.classList.add('d-none');
  }

  function updateStatistics(data) {
    // Update survey info
    updateSurveyInfo(data.survey_info || {});
    
    // Update overview cards with animation
    animateCountUp('total-participants', data.total_participants || 0);
    animateCountUp('total-questions', data.survey_info?.questions_count || 0);
    animateCountUp('avg-responses', Math.round(data.summary?.average_responses_per_question || 0));
    document.getElementById('completion-rate').textContent = (data.summary?.completion_rate || 0) + '%';
    
    // Update detailed questions statistics
    updateQuestionsStats(data.questions_statistics || []);
    
    // Update demographics table (eski usul)
    updateDemographics(data.demographics || {});
    
    // Update recent responses
    updateRecentResponses(data.responses_details || []);
  }

  function animateCountUp(elementId, targetValue) {
    const element = document.getElementById(elementId);
    const duration = 1500;
    const startValue = 0;
    const increment = targetValue / (duration / 16);
    let currentValue = startValue;

    const timer = setInterval(() => {
      currentValue += increment;
      if (currentValue >= targetValue) {
        element.textContent = targetValue;
        clearInterval(timer);
      } else {
        element.textContent = Math.floor(currentValue);
      }
    }, 16);
  }

  function updateSurveyInfo(surveyInfo) {
    const container = document.getElementById('survey-info');
    const createdAt = surveyInfo.created_at ? new Date(surveyInfo.created_at).toLocaleString('uz-UZ') : 'Noma\'lum';
    const isActive = surveyInfo.is_active ? 'Faol' : 'Nofaol';
    const isAnonymous = surveyInfo.is_anonymous ? 'Ha' : 'Yo\'q';
    
    container.innerHTML = `
      <div class="row g-4">
        <div class="col-md-6">
          <div class="info-item">
            <h6 class="fw-bold text-primary mb-2"><i class="fas fa-tag me-2"></i>Sarlavha</h6>
            <p class="mb-3">${surveyInfo.title || 'Noma\'lum'}</p>
          </div>
          <div class="info-item">
            <h6 class="fw-bold text-primary mb-2"><i class="fas fa-calendar me-2"></i>Yaratilgan vaqt</h6>
            <p class="mb-3">${createdAt}</p>
          </div>
          <div class="info-item">
            <h6 class="fw-bold text-primary mb-2"><i class="fas fa-question-circle me-2"></i>Savollar soni</h6>
            <p class="mb-0">${surveyInfo.questions_count || 0}</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="info-item">
            <h6 class="fw-bold text-primary mb-2"><i class="fas fa-toggle-on me-2"></i>Holati</h6>
            <p class="mb-3"><span class="badge ${surveyInfo.is_active ? 'bg-success' : 'bg-secondary'} px-3 py-2">${isActive}</span></p>
          </div>
          <div class="info-item">
            <h6 class="fw-bold text-primary mb-2"><i class="fas fa-user-secret me-2"></i>Anonim</h6>
            <p class="mb-3"><span class="badge ${surveyInfo.is_anonymous ? 'bg-warning text-dark' : 'bg-info'} px-3 py-2">${isAnonymous}</span></p>
          </div>
          <div class="info-item">
            <h6 class="fw-bold text-primary mb-2"><i class="fas fa-users me-2"></i>Jami javoblar</h6>
            <p class="mb-0"><span class="badge bg-primary px-3 py-2">${surveyInfo.total_responses || 0}</span></p>
          </div>
        </div>
      </div>
    `;
  }

  function createCharts(data) {
    // Destroy existing charts
    Object.values(charts).forEach(chart => {
      if (chart) chart.destroy();
    });
    charts = {};

    const demographics = data.demographics || {};

    // Faculty Pie Chart - with fallback data
    const facultyData = demographics.by_faculty || {};
    if (Object.keys(facultyData).length > 0) {
      createPieChart('facultyChart', facultyData, 'Fakultet bo\'yicha taqsimot', [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
      ]);
    } else {
      showNoDataChart('facultyChart', 'Fakultet bo\'yicha ma\'lumot topilmadi');
    }

    // Level Pie Chart - with fallback data  
    const levelData = demographics.by_level || {};
    if (Object.keys(levelData).length > 0) {
      createPieChart('levelChart', levelData, 'Kurs bo\'yicha taqsimot', [
        '#36A2EB', '#FF6384', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
      ]);
    } else {
      showNoDataChart('levelChart', 'Kurs bo\'yicha ma\'lumot topilmadi');
    }

    // Gender Doughnut Chart - with fallback data
    const genderData = demographics.by_gender || {};
    if (Object.keys(genderData).length > 0) {
      createDoughnutChart('genderChart', genderData, 'Jins bo\'yicha taqsimot', [
        '#FF6384', '#36A2EB'
      ]);
    } else {
      showNoDataChart('genderChart', 'Jins bo\'yicha ma\'lumot topilmadi');
    }

    // Education Form Bar Chart - with fallback data
    const educationData = demographics.by_education_form || {};
    if (Object.keys(educationData).length > 0) {
      createBarChart('educationChart', educationData, 'Ta\'lim shakli bo\'yicha', [
        '#FFCE56', '#4BC0C0', '#9966FF'
      ]);
    } else {
      showNoDataChart('educationChart', 'Ta\'lim shakli bo\'yicha ma\'lumot topilmadi');
    }

    // Questions Analysis Line Chart
    if (data.questions_statistics && data.questions_statistics.length > 0) {
      createQuestionsChart(data.questions_statistics);
    } else {
      showNoDataChart('questionsChart', 'Savollar bo\'yicha ma\'lumot topilmadi');
    }
  }

  function createPieChart(canvasId, data, title, colors) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;

    const labels = Object.keys(data);
    const values = Object.values(data);

    charts[canvasId] = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: values,
          backgroundColor: colors.slice(0, labels.length),
          borderColor: '#fff',
          borderWidth: 3,
          hoverOffset: 10
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: title,
            font: { size: 16, weight: 'bold' },
            padding: 20
          },
          legend: {
            position: 'bottom',
            labels: {
              padding: 20,
              usePointStyle: true,
              font: { size: 12 }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const total = values.reduce((a, b) => a + b, 0);
                const percentage = ((context.parsed / total) * 100).toFixed(1);
                return `${context.label}: ${context.parsed} (${percentage}%)`;
              }
            }
          }
        },
        animation: {
          animateRotate: true,
          duration: 1500
        }
      }
    });
  }

  function createDoughnutChart(canvasId, data, title, colors) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;

    const labels = Object.keys(data);
    const values = Object.values(data);

    charts[canvasId] = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: values,
          backgroundColor: colors.slice(0, labels.length),
          borderColor: '#fff',
          borderWidth: 4,
          hoverOffset: 15
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '60%',
        plugins: {
          title: {
            display: true,
            text: title,
            font: { size: 16, weight: 'bold' },
            padding: 20
          },
          legend: {
            position: 'bottom',
            labels: {
              padding: 20,
              usePointStyle: true,
              font: { size: 12 }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const total = values.reduce((a, b) => a + b, 0);
                const percentage = ((context.parsed / total) * 100).toFixed(1);
                return `${context.label}: ${context.parsed} (${percentage}%)`;
              }
            }
          }
        },
        animation: {
          animateRotate: true,
          duration: 1500
        }
      }
    });
  }

  function createBarChart(canvasId, data, title, colors) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;

    const labels = Object.keys(data);
    const values = Object.values(data);

    charts[canvasId] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Talabalar soni',
          data: values,
          backgroundColor: colors.slice(0, labels.length),
          borderColor: colors.slice(0, labels.length).map(color => color + 'CC'),
          borderWidth: 2,
          borderRadius: 8,
          borderSkipped: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: title,
            font: { size: 16, weight: 'bold' },
            padding: 20
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        },
        animation: {
          duration: 1500,
          easing: 'easeInOutBounce'
        }
      }
    });
  }

  function createQuestionsChart(questionsData) {
    const ctx = document.getElementById('questionsChart');
    if (!ctx) return;

    const labels = questionsData.map((q, index) => `Savol ${index + 1}`);
    const answers = questionsData.map(q => q.total_answers || 0);

    charts['questionsChart'] = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Javoblar soni',
          data: answers,
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointBackgroundColor: '#667eea',
          pointBorderColor: '#fff',
          pointBorderWidth: 3,
          pointRadius: 6,
          pointHoverRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Har bir savol uchun javoblar soni',
            font: { size: 16, weight: 'bold' },
            padding: 20
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        },
        animation: {
          duration: 2000,
          easing: 'easeInOutQuart'
        }
      }
    });
  }

  function showNoDataChart(canvasId, message) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;

    // Clear canvas and show message
    const canvas = ctx;
    const container = canvas.parentNode;
    
    // Create no-data message
    const noDataDiv = document.createElement('div');
    noDataDiv.className = 'no-data-chart d-flex flex-column align-items-center justify-content-center';
    noDataDiv.style.height = '300px';
    noDataDiv.innerHTML = `
      <div class="text-center">
        <i class="fas fa-chart-pie text-muted mb-3" style="font-size: 4rem; opacity: 0.3;"></i>
        <h6 class="text-muted">${message}</h6>
        <p class="small text-muted">Ma'lumotlar yig'ilgach, bu yerda chart ko'rinadi</p>
      </div>
    `;
    
    // Hide canvas and show message
    canvas.style.display = 'none';
    container.appendChild(noDataDiv);
  }

  function updateQuestionsStats(questionsStats) {
    const container = document.getElementById('questions-stats-container');
    let html = '';
    
    questionsStats.forEach((question, index) => {
      html += `
        <div class="question-stat-item" data-aos="fade-right" data-aos-delay="${index * 100}">
          <h6 class="fw-bold mb-3 text-primary">
            <i class="fas fa-question-circle me-2"></i>${index + 1}. ${question.text}
          </h6>
          <div class="row mb-3">
            <div class="col-md-4">
              <small class="text-muted">
                <i class="fas fa-tag me-1"></i>Turi: 
                <strong class="text-info">${getQuestionType(question.question_type)}</strong>
              </small>
            </div>
            <div class="col-md-4">
              <small class="text-muted">
                <i class="fas fa-reply me-1"></i>Javoblar: 
                <strong class="text-success">${question.total_answers}</strong>
              </small>
            </div>
            <div class="col-md-4">
              <small class="text-muted">
                <i class="fas fa-exclamation me-1"></i>Majburiy: 
                <strong class="${question.is_required ? 'text-danger' : 'text-secondary'}">${question.is_required ? 'Ha' : 'Yo\'q'}</strong>
              </small>
            </div>
          </div>
      `;
      
      if (question.question_type === 'text') {
        html += '<div class="mt-3"><h6 class="text-primary"><i class="fas fa-align-left me-2"></i>Matnli javoblar (birinchi 10 ta):</h6>';
        if (question.text_answers && question.text_answers.length > 0) {
          question.text_answers.slice(0, 10).forEach(answer => {
            html += `<div class="alert alert-light py-2 px-3 mb-2 border-start border-primary border-3 small">${answer}</div>`;
          });
        } else {
          html += '<p class="text-muted small">Matnli javoblar mavjud emas.</p>';
        }
        html += '</div>';
      } else if (question.choices_stats && question.choices_stats.length > 0) {
        html += '<div class="mt-3"><h6 class="text-primary"><i class="fas fa-chart-bar me-2"></i>Variantlar bo\'yicha taqsimot:</h6>';
        question.choices_stats.forEach((choice, choiceIndex) => {
          const percentage = choice.percentage || 0;
          html += `
            <div class="mb-3" data-aos="fade-left" data-aos-delay="${(index * 100) + (choiceIndex * 50)}">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-medium">${choice.text}</span>
                <span class="badge bg-primary px-3 py-2">
                  ${choice.count} (${percentage.toFixed(1)}%)
                </span>
              </div>
              <div class="choice-bar">
                <div class="choice-fill" style="width: ${percentage}%"></div>
              </div>
            </div>
          `;
        });
        html += '</div>';
      }
      
      html += '</div>';
    });
    
    container.innerHTML = html;
  }

  function updateDemographics(demographics) {
    const container = document.getElementById('demographics-container');
    let html = '<div class="row">';
    
    Object.entries(demographics).forEach(([key, stats]) => {
      if (Object.keys(stats).length > 0) {
        const title = getDemographicTitle(key);
        html += `<div class="col-md-6 col-lg-4 mb-4">
          <div class="demographic-section p-3 border rounded">
            <h6 class="fw-bold text-primary mb-3">
              <i class="fas fa-chart-bar me-2"></i>${title}
            </h6>`;
        
        Object.entries(stats).forEach(([label, count]) => {
          html += `<div class="demographic-item d-flex justify-content-between align-items-center py-2 border-bottom">
            <span class="text-dark">${label}</span>
            <span class="badge bg-primary px-3 py-2">${count}</span>
          </div>`;
        });
        
        html += '</div></div>';
      }
    });
    
    html += '</div>';
    
    if (Object.keys(demographics).length === 0 || Object.values(demographics).every(stats => Object.keys(stats).length === 0)) {
      html = `
        <div class="text-center py-5">
          <i class="fas fa-users text-muted mb-3" style="font-size: 3rem; opacity: 0.3;"></i>
          <h6 class="text-muted">Demografik ma'lumotlar mavjud emas</h6>
          <p class="small text-muted">So'rovnoma anonim yoki ma'lumotlar yig'ilmagan</p>
        </div>
      `;
    }
    
    container.innerHTML = html;
  }

  function getDemographicTitle(key) {
    const titles = {
      'by_faculty': 'Fakultet bo\'yicha',
      'by_level': 'Kurs bo\'yicha', 
      'by_gender': 'Jins bo\'yicha',
      'by_education_form': 'Ta\'lim shakli bo\'yicha',
      'by_payment_form': 'To\'lov shakli bo\'yicha',
      'by_social_category': 'Ijtimoiy holat bo\'yicha',
      'by_accommodation': 'Turar joy bo\'yicha'
    };
    return titles[key] || key;
  }

  function getQuestionType(type) {
    const types = {
      'single_choice': 'Bitta tanlov',
      'multiple_choice': 'Ko\'p tanlov',
      'text': 'Matn'
    };
    return types[type] || type;
  }

  function updateRecentResponses(responses) {
    const tableBody = document.querySelector('#responses-table tbody');
    tableBody.innerHTML = '';
    
    if (responses.length === 0) {
      document.getElementById('responses-section').style.display = 'none';
      return;
    }
    
    responses.slice(0, 20).forEach((response, index) => {
      const student = response.student_info || {};
      const submittedAt = response.submitted_at ? 
        new Date(response.submitted_at).toLocaleString('uz-UZ') : 'Noma\'lum';
      
      const row = `
        <tr data-aos="fade-up" data-aos-delay="${index * 50}">
          <td><span class="badge bg-light text-dark">${student.student_id_number || 'N/A'}</span></td>
          <td class="fw-medium">${student.full_name || 'N/A'}</td>
          <td><small class="text-muted">${student.faculty || 'N/A'}</small></td>
          <td><span class="badge bg-info">${student.level || 'N/A'}</span></td>
          <td><small class="text-muted">${submittedAt}</small></td>
          <td><span class="badge bg-success">${response.answers_count || 0}</span></td>
        </tr>
      `;
      tableBody.innerHTML += row;
    });
  }

  // Global functions for buttons
  window.refreshStats = function() {
    loadStats();
  };

  window.exportStats = function() {
    // Create comprehensive CSV content
    const csvContent = "data:text/csv;charset=utf-8," + 
      "So'rovnoma statistikasi eksporti\\n" +
      "Yaratilgan: " + new Date().toLocaleString('uz-UZ') + "\\n\\n";
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `survey_${surveyId}_statistics_${Date.now()}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Show success message
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
    alert.style.zIndex = '9999';
    alert.innerHTML = `
      <i class="fas fa-check-circle me-2"></i>
      Statistika muvaffaqiyatli eksport qilindi!
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    
    setTimeout(() => {
      if (alert.parentNode) {
        alert.parentNode.removeChild(alert);
      }
    }, 3000);
  };
});
</script>
{% endblock %}
